#!/usr/bin/env node

/**
 * Sync PEAC version from installed @peac/protocol package
 * READ-ONLY from deps - writes only to this repo's lib/constants/peac.ts
 *
 * Wire types are DECOUPLED from package version:
 * - PEAC_VERSION = monorepo release (e.g., 0.10.0)
 * - PEAC_RECEIPT_TYP = wire type (e.g., peac-receipt/0.1) - hyphenated, separate versioning
 * - PEAC_POLICY_TYP = policy doc type (e.g., peac-policy/0.1)
 */

import { createRequire } from 'module'
import { writeFileSync, mkdirSync } from 'fs'
import { dirname, join } from 'path'
import { fileURLToPath } from 'url'

const __dirname = dirname(fileURLToPath(import.meta.url))
const require = createRequire(import.meta.url)

let version = '0.10.0' // fallback

try {
  // Try to read from installed @peac/protocol package
  const pkg = require('@peac/protocol/package.json')
  version = pkg.version
  console.log('Read PEAC version from @peac/protocol:', version)
} catch (e) {
  console.warn('Could not read @peac/protocol version, using fallback:', version)
  console.warn('Install @peac/protocol as a dependency to enable auto-sync')
}

// Wire types are DECOUPLED from package version - do not compute from semver
const constants = `// Auto-generated by scripts/sync-peac-version.mjs - do not edit manually
// Run: node scripts/sync-peac-version.mjs

// Monorepo release version
export const PEAC_VERSION = '${version}'

// Wire type for receipts (hyphenated format, separate versioning from PEAC_VERSION)
export const PEAC_RECEIPT_TYP = 'peac-receipt/0.1'

// Policy document type
export const PEAC_POLICY_TYP = 'peac-policy/0.1'
`

const outputPath = join(__dirname, '..', 'lib', 'constants', 'peac.ts')

// Ensure directory exists
mkdirSync(dirname(outputPath), { recursive: true })

writeFileSync(outputPath, constants)
console.log('Wrote PEAC constants to:', outputPath)
